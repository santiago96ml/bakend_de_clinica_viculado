# Reporte de Vulnerabilidades - Vintex Backend

## 1. Validación de Extensiones de Archivo Defectuosa (CRÍTICA)
**Ubicación:** `server.js` - Endpoint `/api/files/confirm-upload`

**Descripción:**
La lógica para detectar extensiones peligrosas es incorrecta:
```javascript
const dangerousExtensions = ['.php', '.exe', '.sh', '.js', '.bat'];
if (dangerousExtensions.some(ext => fileName.toLowerCase().includes(ext + '.'))) ...
```
Esta comprobación busca la extensión seguida de un punto (ej. `.php.`).
Esto bloquea `archivo.php.jpg` (doble extensión), pero **PERMITE** `malware.php`, ya que no hay un punto después de `php`.

**Impacto:**
Un atacante (o staff comprometido) puede subir webshells (`.php`), scripts (`.js`, `.sh`) o ejecutables (`.exe`) al servidor de almacenamiento, lo que podría comprometer completamente el servidor o la infraestructura de almacenamiento.

**Prueba de Concepto (JS):**
`"malware.php".includes(".php.")` devuelve `false`.

**Recomendación:**
Usar `path.extname` o verificar si la cadena *termina* con la extensión.
```javascript
const ext = fileName.split('.').pop().toLowerCase();
if (dangerousExtensions.some(d => d.includes(ext))) ...
```

## 2. Lista Negra de Extensiones Incompleta (ALTA)
**Ubicación:** `server.js` - Endpoint `/api/files/confirm-upload`

**Descripción:**
La lista de extensiones prohibidas no incluye tipos de archivo que permiten Cross-Site Scripting (XSS) u otros ataques del lado del cliente.
Faltan: `.html`, `.htm`, `.svg`, `.xml`.

**Impacto:**
Un atacante puede subir un archivo HTML malicioso. Si un administrador lo descarga y lo abre, se ejecutará JavaScript en su navegador, permitiendo robo de sesión o phishing.

## 3. Falta de Validación de `clienteId` en Subida (MEDIA)
**Ubicación:** `server.js` - Endpoint `/api/files/generate-upload-url`

**Descripción:**
No se verifica si el `clienteId` proporcionado existe en la base de datos antes de generar la URL de subida.

**Impacto:**
Un usuario autenticado puede subir archivos asociados a IDs arbitrarios. Esto permite:
1. Llenar el almacenamiento con archivos "huérfanos".
2. Potencialmente confundir a la aplicación si luego se crean clientes con esos IDs.

## 4. Uso de Service Key (Riesgo Arquitectónico - MEDIO/ALTO)
**Descripción:**
El backend utiliza la `SUPABASE_SERVICE_KEY` para todas las operaciones con la base de datos de la clínica. Esto bypassa las políticas de seguridad (RLS) de Supabase.

**Detalle:**
Al usar `createClient(url, key)`, el backend tiene permisos de superadministrador. La seguridad depende al 100% de que el código JS no tenga errores de lógica. Cualquier bug en un `select` o `insert` podría exponer o corromper datos de toda la clínica.

**Recomendación:**
Si es posible, implementar Row Level Security (RLS) y usar tokens de usuario autenticados contra Supabase directamente, o asegurar auditorías de código extremadamente rigurosas.

## 5. Versión de Dependencia Incorrecta (BAJA)
**Ubicación:** `package.json`

**Descripción:**
`zod` está listado con versión `^3.25.76`, la cual no parece existir (actual es ~3.24).
Esto puede indicar un error tipográfico o un intento de "typosquatting" si el paquete fuera descargado de una fuente no confiable. Probablemente romperá la instalación (`npm install`).

## 6. Lista Blanca de Mime Types Incompleta (INFO)
**Ubicación:** `server.js` - Endpoint `/api/files/confirm-upload`

**Descripción:**
La lista `mimeMap` es limitada. Si se quieren soportar más tipos de archivos en el futuro, habrá que actualizarla manualmente. Esto es bueno por seguridad (lista blanca), pero requiere mantenimiento.
